name: Build and Deploy Frappe Custom App

on:
  workflow_dispatch:
    inputs:
      frappe_branch:
        description: 'Frappe branch (e.g., version-15, version-14)'
        required: true
      site_name:
        description: 'Site name'
        required: true
      http_port:
        description: 'HTTP port for this site (required, e.g., 8080, 8081, 8082)'
        required: true
      db_password:
        description: 'Database password (optional, default: 123)'
        required: false
      admin_password:
        description: 'Admin password (optional, default: admin)'
        required: false
      install_apps:
        description: 'Apps to install (optional, default: frappe)'
        required: false

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build:
    name: Build Custom Frappe Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.commit.outputs.hash }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get commit hash
        id: commit
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "Building image with tag: ${COMMIT_HASH}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Validate apps.json
        run: |
          if [ ! -f "apps.json" ]; then
            echo "Error: apps.json not found"
            exit 1
          fi
          
          if ! jq empty apps.json; then
            echo "Error: Invalid JSON in apps.json"
            exit 1
          fi

      - name: Generate APPS_JSON_BASE64
        id: apps_json
        run: |
          APPS_JSON_BASE64=$(base64 -w 0 apps.json)
          echo "apps_json_base64=${APPS_JSON_BASE64}" >> $GITHUB_OUTPUT

      - name: Build custom Frappe image
        run: |
          docker build \
            --build-arg=FRAPPE_PATH=https://github.com/frappe/frappe \
            --build-arg=FRAPPE_BRANCH=${{ inputs.frappe_branch }} \
            --build-arg=APPS_JSON_BASE64=${{ steps.apps_json.outputs.apps_json_base64 }} \
            --tag=roohmeiy/frappe-layered:${{ steps.commit.outputs.hash }} \
            --file=Dockerfile \
            .

      - name: Push image to Docker Hub
        run: |
          docker push roohmeiy/frappe-layered:${{ steps.commit.outputs.hash }}

  deploy:
    name: Deploy to Local Server
    runs-on: self-hosted
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate project name
        id: project
        run: |
          # Create a safe project name from site name
          PROJECT_NAME=$(echo "${{ inputs.site_name }}" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
          echo "name=${PROJECT_NAME}" >> $GITHUB_OUTPUT
          echo "Project name: ${PROJECT_NAME}"

      - name: Check for port conflicts
        run: |
          PORT=${{ inputs.http_port }}
          if netstat -tuln | grep -q ":${PORT} "; then
            echo "⚠️  Warning: Port ${PORT} is already in use"
            echo "Please choose a different port or stop the service using this port"
            exit 1
          fi
          echo "✓ Port ${PORT} is available"

      # - name: Set deployment parameters
      #   run: |
      #     echo "ERPNEXT_VERSION=${{ needs.build.outputs.image_tag }}" >> $GITHUB_ENV
      #     echo "SITE_NAME=${{ inputs.site_name }}" >> $GITHUB_ENV
      #     echo "HTTP_PUBLISH_PORT=${{ inputs.http_port }}" >> $GITHUB_ENV
      #     echo "DB_PASSWORD=${{ inputs.db_password || '123' }}" >> $GITHUB_ENV
      #     echo "ADMIN_PASSWORD=${{ inputs.admin_password || 'admin' }}" >> $GITHUB_ENV
      #     echo "INSTALL_APPS=${{ inputs.install_apps || 'frappe' }}" >> $GITHUB_ENV

      - name: Deploy with docker-compose
        run: |
          PROJECT_NAME="${{ steps.project.outputs.name }}"
          
          echo "Deploying project: ${PROJECT_NAME}"
          echo "Site: ${{ inputs.site_name }}"
          echo "Port: ${{ inputs.http_port }}"
          
          # Export environment variables for docker-compose
          export ERPNEXT_VERSION="${{ needs.build.outputs.image_tag }}"
          export SITE_NAME="${{ inputs.site_name }}"
          export HTTP_PUBLISH_PORT="${{ inputs.http_port }}"
          export DB_PASSWORD="${{ inputs.db_password || '123' }}"
          export ADMIN_PASSWORD="${{ inputs.admin_password || 'admin' }}"
          export INSTALL_APPS="${{ inputs.install_apps || 'frappe' }}"
          
          # Deploy using project name to isolate this stack
          docker-compose -p "${PROJECT_NAME}" up -d
          
          echo "Waiting for services to start..."
          sleep 30

      - name: Verify deployment
        run: |
          max_attempts=30
          attempt=0
          PORT=${{ inputs.http_port }}
                    
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:${PORT}/api/method/ping 2>/dev/null; then
              echo "✓ Site is responding on port ${PORT}"
              break
            fi
            attempt=$((attempt + 1))
            sleep 10
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Site did not respond after $max_attempts attempts"
            echo "Showing logs:"
            docker-compose -p "${{ steps.project.outputs.name }}" logs --tail=100
            exit 1
          fi

      - name: Deployment summary
        run: |
          echo "✓ Deployment completed successfully!"
          echo "=== Deployment Details ==="
          echo "Project Name: ${{ steps.project.outputs.name }}"
          echo "Site Name: ${{ inputs.site_name }}"
          echo "Image: roohmeiy/frappe-layered:${{ needs.build.outputs.image_tag }}"
          echo "Access URL: http://localhost:${{ inputs.http_port }}"
          echo "Installed Apps: ${{ inputs.install_apps || 'frappe (default)' }}"
         
