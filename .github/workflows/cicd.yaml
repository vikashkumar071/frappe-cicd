name: Build and Deploy Frappe Custom App

on:
  workflow_dispatch:
    inputs:
      frappe_branch:
        description: 'Frappe branch (e.g., version-15, version-14)'
        required: true
      db_password:
        description: 'Database password (optional, default: 123)'
        required: false
      admin_password:
        description: 'Admin password (optional, default: admin)'
        required: false
      site_name:
        description: 'Site name (required)'
        required: true
      install_apps:
        description: 'Apps to install (optional, default: frappe)'
        required: false

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build:
    name: Build Custom Frappe Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.commit.outputs.hash }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get commit hash
        id: commit
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "Building image with tag: ${COMMIT_HASH}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Validate apps.json
        run: |
          if [ ! -f "apps.json" ]; then
            echo "Error: apps.json not found"
            exit 1
          fi
          
          if ! jq empty apps.json; then
            echo "Error: Invalid JSON in apps.json"
            exit 1
          fi

      - name: Generate APPS_JSON_BASE64
        id: apps_json
        run: |
          APPS_JSON_BASE64=$(base64 -w 0 apps.json)
          echo "apps_json_base64=${APPS_JSON_BASE64}" >> $GITHUB_OUTPUT

      - name: Build custom Frappe image
        run: |
          docker build \
            --build-arg=FRAPPE_PATH=https://github.com/frappe/frappe \
            --build-arg=FRAPPE_BRANCH=${{ inputs.frappe_branch }} \
            --build-arg=APPS_JSON_BASE64=${{ steps.apps_json.outputs.apps_json_base64 }} \
            --tag=roohmeiy/frappe-layered:${{ steps.commit.outputs.hash }} \
            --file=Dockerfile \
            .

      - name: Push image to Docker Hub
        run: |
          docker push roohmeiy/frappe-layered:${{ steps.commit.outputs.hash }}

      - name: Build summary
        run: |
          echo "✓ Build completed"
          echo "Image: roohmeiy/frappe-layered:${{ steps.commit.outputs.hash }}"
          echo "Frappe Branch: ${{ inputs.frappe_branch }}"

  deploy:
    name: Deploy to Local Server
    runs-on: self-hosted
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set deployment parameters
        run: |
          # Only set parameters if provided, otherwise docker-compose uses defaults
          if [ -n "${{ inputs.db_password }}" ]; then
            echo "DB_PASSWORD=${{ inputs.db_password }}" >> $GITHUB_ENV
          fi
          
          if [ -n "${{ inputs.admin_password }}" ]; then
            echo "ADMIN_PASSWORD=${{ inputs.admin_password }}" >> $GITHUB_ENV
          fi
          
          if [ -n "${{ inputs.site_name }}" ]; then
            echo "SITE_NAME=${{ inputs.site_name }}" >> $GITHUB_ENV
          fi
          
          if [ -n "${{ inputs.install_apps }}" ]; then
            echo "INSTALL_APPS=${{ inputs.install_apps }}" >> $GITHUB_ENV
          fi

      - name: Deploy with docker-compose
        run: |
          docker-compose down || true
          docker-compose up -d

      - name: Wait for services
        run: |
          sleep 30

      - name: Verify deployment
        run: |
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:80/api/method/ping 2>/dev/null; then
              echo "✓ Site is responding"
              break
            fi
            attempt=$((attempt + 1))
            sleep 10
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Site did not respond"
            docker-compose logs --tail=100
            exit 1
          fi

